<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š</title>
    <style>
      body {
        font-family: 'Roboto', Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’0ã«è¨­å®š */
        padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’0ã«è¨­å®š */
        color: #333;
        height: 100vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã„ã£ã±ã„ã«è¨­å®š */
        overflow: hidden; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’éš ã™ */
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
      }
      h2 {
        color: #2c3e50;
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
      }
      .section {
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #34495e;
      }
      .setting {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
      }
      .setting-label {
        font-weight: bold;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #2196F3;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .toggle-switch.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .toggle-switch.loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 34px;
      }
      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #3498db;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .quote-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
      }
      .character-image {
        width: 100px;
        height: 100px;
        margin-right: 15px;
        border-radius: 50%;
        object-fit: cover;
        display: none; /* åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º */
      }
      .character-quote {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
      }
      
      /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%; /* 100vhã‹ã‚‰100%ã«å¤‰æ›´ */
        width: 100%; /* å¹…ã‚’100%ã«è¨­å®š */
        position: fixed; /* å›ºå®šä½ç½®ã«è¨­å®š */
        top: 0;
        left: 0;
        background-color: #f5f5f5; /* èƒŒæ™¯è‰²ã‚’è¨­å®š */
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .loading-text {
        margin-top: 20px;
        font-size: 1.2em;
        color: #333;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
    
    <div id="content" style="display: none;">
      <div class="container">
        <div class="quote-container">
          <img id="character-image" class="character-image" src="" alt="Character">
          <div id="character-quote" class="character-quote"></div>
        </div>
        <div id="settings"></div>
      </div>
    </div>
    
    <script>
      const characterQuotes = {
        anderson: {
          quotes: [
            {text: "å›ã®æŒ‡æ®ã«æœŸå¾…ã—ã¦ã„ã‚‹", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/anderson/anderson_1.jpg?raw=true"},
            {text: "çµæœã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/anderson/anderson_1.jpg?raw=true"}
          ]
        },
        mustang: {
          quotes: [
            {text: "Youã®å®ŸåŠ›ã€è¦‹ã›ã¦ãã ã•ã„YOï¼", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/mustang/mustang_1.png?raw=true"},
            {text: "ã‚¨ãƒ³ã‚¿ã‚¡ã‚¡ãƒ¼ãƒ¼ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã‚©ãƒ¼ãƒ¼ãƒ¼ï¼", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/mustang/mustang_2.png?raw=true"}
          ]
        },
        shuen: {
          quotes: [
            {text: "é‰„ããšã©ã‚‚ã®å®ŸåŠ›ã€ã¿ã›ã¦ã‚‚ã‚‰ãŠã†ã‹ã—ã‚‰", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/shuen/shuen_1.jpg?raw=true"},
            {text: "ãƒŸã‚·ãƒªã‚¹ã®CEOã§ã‚ã‚‹ç§ãŒï¼ã‚ã–ã‚ã–è¶³ã‚’é‹ã‚“ã§ã‚ã’ãŸã®ã‚ˆï¼Ÿ", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/shuen/shuen_2.jpg?raw=true"}
          ]
        },
        ingrid: {
          quotes: [
            {text: "ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«ãªæŒ‡æ®ã«æœŸå¾…ã—ã¦ã„ã‚‹", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/ingrid/ingrid_1.png?raw=true"},
            {text: "ãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã ãï¼é™ç²›ã«ï¼ğŸ’¢", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/ingrid/ingrid_2.jpg?raw=true"}
          ]
        },
        shifty: {
          quotes: [
            {text: "æŒ‡æ®å®˜ï¼Ÿï¼Ÿ...æŒ‡æ®ã‹ãƒ¼ã‚“ï¼...æŒ‡æ®å®˜ï¼Ÿ", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/shifty/shifty_1.png?raw=true"},
            {text: "ã“ã‚“ã«ã¡ã¯ã€æŒ‡æ®å®˜ï¼", image: "https://github.com/mickitty0511/nikke_admin_google_apps/blob/main/src/imgs/characters/shifty/shifty_1.png?raw=true"},
          ]
        }
      };

      function getRandomQuoteAndImage() {
        const characters = Object.keys(characterQuotes);
        const randomCharacter = characters[Math.floor(Math.random() * characters.length)];
        const character = characterQuotes[randomCharacter];
        const randomQuoteIndex = Math.floor(Math.random() * character.quotes.length);
        return character.quotes[randomQuoteIndex];
      }

      // displayRandomQuoteAndImage é–¢æ•°ã‚’ä¿®æ­£
      async function displayRandomQuoteAndImage() {
        const { text, image } = getRandomQuoteAndImage();
        const quoteElement = document.getElementById('character-quote');
        const imageElement = document.getElementById('character-image');
        quoteElement.textContent = text;
        imageElement.style.display = 'none'; // ç”»åƒã‚’ä¸€æ—¦éè¡¨ç¤ºã«

        // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
        await new Promise((resolve, reject) => {
          imageElement.onload = resolve;
          imageElement.onerror = reject;
          imageElement.src = image;
        }).catch(() => {
          console.error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', image);
        });

        imageElement.style.display = 'block'; // ç”»åƒã‚’è¡¨ç¤º
      }

      // è¨­å®šã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
      async function loadSettings() {
        await waitForPageLoad();
        const settings = await new Promise((resolve) => {
          google.script.run.withSuccessHandler(resolve).getSettings();
        });
        displaySettings(settings);
        await displayRandomQuoteAndImage();
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã™ã‚‹
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      }
      
      // è¨­å®šã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
      function displaySettings(settings) {
        const settingsDiv = document.getElementById('settings');
        settingsDiv.innerHTML = '';
        
        for (const [sectionName, sectionSettings] of Object.entries(settings)) {
          const sectionDiv = document.createElement('div');
          sectionDiv.className = 'section';
          
          const sectionTitle = document.createElement('div');
          sectionTitle.className = 'section-title';
          sectionTitle.textContent = sectionName;
          sectionDiv.appendChild(sectionTitle);
          
          for (const [key, value] of Object.entries(sectionSettings)) {
            const settingDiv = document.createElement('div');
            settingDiv.className = 'setting';
            
            const label = document.createElement('span');
            label.className = 'setting-label';
            label.textContent = key;
            settingDiv.appendChild(label);
            
            const toggleSwitch = document.createElement('label');
            toggleSwitch.className = 'toggle-switch';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = value;
            checkbox.onchange = (e) => updateSetting(sectionName, key, e.target);
            
            const slider = document.createElement('span');
            slider.className = 'slider';
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.style.display = 'none';
            
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'loading-spinner';
            
            loadingOverlay.appendChild(loadingSpinner);
            
            toggleSwitch.appendChild(checkbox);
            toggleSwitch.appendChild(slider);
            toggleSwitch.appendChild(loadingOverlay);
            settingDiv.appendChild(toggleSwitch);
            
            sectionDiv.appendChild(settingDiv);
          }
          
          settingsDiv.appendChild(sectionDiv);
        }
      }
      
      // è¨­å®šã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      function updateSetting(section, key, checkbox) {
        const toggleSwitch = checkbox.closest('.toggle-switch');
        const loadingOverlay = toggleSwitch.querySelector('.loading-overlay');
        
        // ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        toggleSwitch.classList.add('loading');
        loadingOverlay.style.display = 'flex';
        
        google.script.run
          .withSuccessHandler((result) => {
            displaySettings(result);
            // ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            toggleSwitch.classList.remove('loading');
            loadingOverlay.style.display = 'none';
          })
          .withFailureHandler((error) => {
            console.error('Error updating setting:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
            checkbox.checked = !checkbox.checked;
            toggleSwitch.classList.remove('loading');
            loadingOverlay.style.display = 'none';
          })
          .updateSetting(section, key, checkbox.checked);
      }
      
      // æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ 
      function waitForPageLoad() {
        return new Promise((resolve) => {
          if (document.readyState === 'complete') {
            resolve();
          } else {
            window.addEventListener('load', resolve);
          }
        });
      }

      // åˆæœŸè¡¨ç¤º
      google.script.run.withSuccessHandler(async (result) => {
        await loadSettings();
      }).initializeSettings();
    </script>
  </body>
</html>
